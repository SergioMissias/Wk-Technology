unit untPedidos;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ComCtrls, Vcl.ExtCtrls,
  Vcl.ToolWin, Data.DB, Vcl.Buttons, Vcl.Grids, Vcl.DBGrids,unDmWkTeste, untProcuraCliente,untProcuraProduto
  , System.UITypes;

type
  TfrmCliente = class(TForm)
    Panel1: TPanel;
    TabControl1: TTabControl;
    Label1: TLabel;
    edtCliente: TEdit;
    Panel2: TPanel;
    edtCodProduto: TEdit;
    edtQuantidade: TEdit;
    edtValorUni: TEdit;
    Label2: TLabel;
    Label3: TLabel;
    lbldescricao: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    lblValorTotal: TLabel;
    btnInserirProd: TBitBtn;
    Panel3: TPanel;
    Label9: TLabel;
    lblValorTotaPedido: TLabel;
    btnGravarPedido: TBitBtn;
    pnlProcPed: TPanel;
    btnPdAntigos: TBitBtn;
    Label11: TLabel;
    edtAchaPedido: TEdit;
    lblNomeCliente: TLabel;
    lblCidade: TLabel;
    lblUF: TLabel;
    btnDeletarPedido: TBitBtn;
    sbProcurarCliente: TSpeedButton;
    dbProdutoPedido: TDBGrid;
    procedure FormShow(Sender: TObject);
    procedure sbProcurarClienteClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure edtCodProdutoExit(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edtQuantidadeExit(Sender: TObject);
    procedure edtValorUniExit(Sender: TObject);
    procedure btnInserirProdClick(Sender: TObject);
    procedure btnGravarPedidoClick(Sender: TObject);
    procedure btnPdAntigosClick(Sender: TObject);
    procedure edtAchaPedidoExit(Sender: TObject);
    procedure edtClienteChange(Sender: TObject);
    procedure dbProdutoPedidoKeyPress(Sender: TObject; var Key: Char);
    procedure dbProdutoPedidoKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure btnDeletarPedidoClick(Sender: TObject);
  private
    { Private declarations }

    oProd:TProcuraProd;
  public
    { Public declarations }
  end;

var
  frmCliente: TfrmCliente;

implementation

{$R *.dfm}

uses untGravaProduto, untGravarPedido, untAchaPedido, untAcharProdutoPedido,
  untDeletarPedido;


//uses unDmWkTeste, untProcuraCliente;

procedure TfrmCliente.btnDeletarPedidoClick(Sender: TObject);
var
DeletarPed:TDeletaPedido;
AtualizaGrid:TAchaPedido;
begin
AtualizaGrid:=TAchaPedido.Create;
DeletarPed:=TDeletaPedido.Create;
if DeletarPed.DeletaPedido(strtoint(edtAchaPedido.Text))=True then
   AtualizaGrid.ProcuraPedido(strtoint(edtAchaPedido.Text));

edtAchaPedido.Text:='';
edtAchaPedido.SetFocus;



end;

procedure TfrmCliente.btnGravarPedidoClick(Sender: TObject);
var
OPedido:TGravaPedido;
Total:TgravarItem;
begin
Total:=TgravarItem.Create;

Opedido:=TGravaPedido.Create;
Opedido.Dia:=datetostr(Now);
OPedido.CodCliente:=strtoint(edtCliente.Text);
OPedido.VTotalPedido:=Total.TotalItens;
if OPedido.GravarPedido = false then
begin
  showmessage('pedido nao gravado');
end
else
begin
  dmWkTeste.cdsProdutosPedido.Close;
  dmWkTeste.cdsProdutosPedido.CreateDataSet;
  edtCliente.Text:='';
  pnlProcPed.Visible:=True;
  edtCodProduto.Text:='';
  edtValorUni.Text:='';
  lblValorTotal.Caption:='0,00';
  lbldescricao.Caption:='';

  edtCliente.SetFocus;

end;



end;

procedure TfrmCliente.btnInserirProdClick(Sender: TObject);
var
GravarProdugo:TgravarItem;
OProd:TProcuraProd;
oProdAlter:TAchaReg;
OPedido:TGravaPedido;
Total:TgravarItem;
begin

   OProd:=TProcuraProd.Create;
   OProd.CodProduto:=strtoint(edtCodProduto.Text);
   OProd.Descricao:=lbldescricao.Caption;
   OProd.PrecoUni:=strtofloat(edtValorUni.Text);
   OProd.quant:=strtoint(edtQuantidade.Text);
if btnInserirProd.tag=0 then
begin
   GravarProdugo:=TgravarItem.Create;

   if GravarProdugo.gravarItem(OProd,strtoint(edtCliente.Text))=False then
   begin
     Showmessage('Erro na Gravação!!');
   end;
   dbProdutoPedido.Refresh;
   lblValorTotaPedido.Caption:=floattostr(GravarProdugo.TotalItens);
   edtCodProduto.SetFocus;
end
else
begin
    oProdAlter:=Tachareg.Create;
    Total:=TgravarItem.Create;
    GravarProdugo:=TgravarItem.Create;
    OProd:=TProcuraProd.Create;
    oProd.Quant:=StrToInt(edtQuantidade.Text);
    Oprod.PrecoUni:=StrToFloat(edtValorUni.Text);


    //Opedido:=TGravaPedido.Create;
    //Opedido.Dia:=datetostr(Now);
    //OPedido.CodCliente:=strtoint(edtCliente.Text);
    //OPedido.VTotalPedido:=Total.TotalItens;

    if oProdAlter.AcharProdutoPedido('Alteração', OProd) = false then
    begin
      showmessage('pedido nao gravado');
    end
    else
    begin
      lblValorTotaPedido.Caption:=floattostr(GravarProdugo.TotalItens);

    end;






  oProdAlter:=TAchaReg.Create;

  oProd.PrecoUni:= strtofloat(edtValorUni.Text);
  OProd.Quant:=strtoint(edtQuantidade.Text);
//  oProdAlter.AcharProdutoPedido('',dmWkTeste.cdsProdutosPedidoAutoincrem.AsInteger,oProd);
end;
end;

procedure TfrmCliente.btnPdAntigosClick(Sender: TObject);

begin
pnlProcPed.Visible:= True;
end;

procedure TfrmCliente.dbProdutoPedidoKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
var
OProd:TProcuraProd;
oProdAlter:TAchaReg;
GravarProdugo:TgravarItem;
begin
if key = 46 then
begin
    GravarProdugo:=TgravarItem.Create;
    oProdAlter:=Tachareg.Create;
    oProd:=TProcuraProd.Create;
    if oProdAlter.AcharProdutoPedido('Exclusão', OProd) = false then
    begin
      showmessage('pedido nao Excluido');
    end
    else
    begin
      lblValorTotaPedido.Caption:=floattostr(GravarProdugo.TotalItens);

    end;
end;

end;

procedure TfrmCliente.dbProdutoPedidoKeyPress(Sender: TObject; var Key: Char);
//var

//OProd:TProcuraProd;
//oProdAlter:TAchaReg;
//GravarProdugo:TgravarItem;
begin
if Key = #13 then
begin
  edtCodProduto.Text:=inttostr(dbProdutoPedido.Fields[0].AsInteger);
  edtQuantidade.Text:=FloatToStr(dbProdutoPedido.Fields[2].asfloat);
  edtValorUni.Text:=FloatToStr(dbProdutoPedido.Fields[3].asfloat);
  lbldescricao.Caption:=dbProdutoPedido.Fields[1].asstring;
  lblValorTotal.Caption:=floattostr(dbProdutoPedido.Fields[5].AsFloat);

  btnInserirProd.Caption:='Alterar Item';
  btnInserirProd.Tag:=1;
  edtCodProduto.ReadOnly:=True;
  edtQuantidade.SetFocus;
end;

end;

procedure TfrmCliente.edtAchaPedidoExit(Sender: TObject);
var
oPedido:TAchaPedido;
begin
if edtAchaPedido.Text<>'' then
begin
oPedido:=TAchaPedido.Create;
if oPedido.ProcuraPedido(strtoint(edtAchaPedido.Text)) =false then
begin
  showmessage('Pedido não encontrado');
  edtAchaPedido.SetFocus;
end
else
begin
  edtCliente.Text:=inttostr(oPedido.CodClie);
  lblNomeCliente.Caption:=oPedido.Nome;
  lblCidade.Caption:=oPedido.Cidade;
  lblUF.Caption:=oPedido.UF;
  lblValorTotaPedido.Caption:=currtostr(oPedido.VlTotalPed);
  btnInserirProd.Caption:='Alterar';
  dbProdutoPedido.SetFocus;
end;

end
else
edtCliente.SetFocus;
end;

procedure TfrmCliente.edtClienteChange(Sender: TObject);
begin
  pnlProcPed.Visible:=False;
  btnInserirProd.Caption:='Inserir';
end;

procedure TfrmCliente.edtCodProdutoExit(Sender: TObject);


begin
if edtCodProduto.Text<>'' then
begin

  oProd:=TProcuraProd.Create;
  if oProd.ProcuraProduto(strtoint(edtCodProduto.Text))=true then
  begin
    lbldescricao.Caption:=oProd.Descricao;
    edtValorUni.Text:=floattostr(oProd.precoUni);
 //   edtQuantidade.SetFocus;
  end
  else
  begin
   MessageDlg('Código de Produto não Cadastrado!',mtError,mbOKCancel,0);
   edtCodProduto.SetFocus;

  end;
end
else
begin
  if MessageDlg('Código de Produto em Branco! Deseja Sair de digitação de Produtos',mtConfirmation,[mbYes, mbNo], 0 )=6 then
  begin
    edtCliente.SetFocus;
  end
  else
     edtCodProduto.SetFocus;

end;
end;

procedure TfrmCliente.edtQuantidadeExit(Sender: TObject);
begin
if (edtQuantidade.Text='0') or (edtQuantidade.Text = '')  then
begin

   MessageDlg('Informe um valor maior que 0 para continuar!',mtError,mbOKCancel,0);
   edtQuantidade.SetFocus;
end;
//edtValorUni.SetFocus;
end;

procedure TfrmCliente.edtValorUniExit(Sender: TObject);
begin
btnInserirProd.SetFocus;
lblValorTotal.Caption:=floattostr(strtofloat(edtQuantidade.Text) *StrToFloat(edtValorUni.Text));
end;

procedure TfrmCliente.FormCreate(Sender: TObject);
begin
edtCliente.Text:='';
edtCodProduto.Text:='';
edtQuantidade.Text:='0';
edtValorUni.Text:='0';
end;

procedure TfrmCliente.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
if Key = VK_RETURN then
   perform(WM_NEXTDLGCTL,0,0);
end;

procedure TfrmCliente.FormShow(Sender: TObject);
begin
  edtCliente.SetFocus;
  btnPdAntigos.Visible:=true;
  pnlProcPed.Visible:=True;
end;

procedure TfrmCliente.sbProcurarClienteClick(Sender: TObject);
var
oCli:TProcCliente;
Begin
if edtCliente.Text<>'' then
begin
 oCli:=TprocCliente.create;
 if ocli.ProcuraCliente(strtoint(edtCliente.Text)) = true then
 begin
    lblNomeCliente.Caption:=oCli.Nome;
    lblCidade.Caption:=oCli.Cidade;
    lblUF.Caption:=oCli.UF;
    dmWkTeste.cdsProdutosPedido.close;
    dmWkTeste.cdsProdutosPedido.CreateDataSet;
    edtCodProduto.ReadOnly:=False;
    edtCodProduto.SetFocus;
 end
 else
 Begin
 MessageDlg('Código de Cliente não Cadastrado!',mtError,mbOKCancel,0);
 edtCliente.SetFocus;
 end;
end
else
begin
  pnlProcPed.Visible:=true;
  edtAchaPedido.SetFocus;
end;





end;

end.
